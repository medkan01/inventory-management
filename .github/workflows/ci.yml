name: CI Pipeline

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]

jobs:
  # Job 1: Lint et vérification du backend Python
  backend-lint:
    name: Backend Lint & Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./api-services
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff pytest

      - name: Lint with Ruff
        working-directory: ./api-services
        run: |
          ruff check app/
        continue-on-error: true

      - name: Check Python syntax
        working-directory: ./api-services
        run: |
          python -m py_compile app/main.py

  # Job 2: Lint et vérification du frontend Next.js
  frontend-lint:
    name: Frontend Lint & Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './client-web-app/package-lock.json'

      - name: Install dependencies
        working-directory: ./client-web-app
        run: npm ci

      - name: Create .env.local for type checking
        working-directory: ./client-web-app
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=https://placeholder.supabase.co" > .env.local
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=placeholder-key" >> .env.local

      - name: Lint with ESLint
        working-directory: ./client-web-app
        run: npm run lint
        continue-on-error: true

      - name: Type check
        working-directory: ./client-web-app
        run: npx tsc --noEmit

  # Job 3: Build Docker images pour vérifier qu'elles fonctionnent
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./api-services
          file: ./api-services/Dockerfile
          push: false
          tags: inventory-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./client-web-app
          file: ./client-web-app/Dockerfile
          push: false
          tags: inventory-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Job 4: Tests d'intégration avec Docker Compose (optionnel au début)
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [backend-lint, frontend-lint, docker-build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          DB_USER=postgres
          DB_PASSWORD=postgres
          DB_NAME=inventory_db_test
          DATABASE_URL=postgresql://postgres:postgres@postgres-database:5432/inventory_db_test
          EOF

      - name: Start services with Docker Compose
        run: |
          docker compose up -d --build
          sleep 15

      - name: Check services are running
        run: |
          docker compose ps
          curl --fail http://localhost:8000/ || exit 1
          curl --fail http://localhost:3000/ || exit 1

      - name: Stop services
        if: always()
        run: docker compose down -v

  # Job final: Résumé du statut
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [backend-lint, frontend-lint, docker-build, integration-test]
    if: success()
    
    steps:
      - name: Success message
        run: echo "✅ All CI checks passed successfully!"
