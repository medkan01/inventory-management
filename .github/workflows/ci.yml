name: CI Pipeline

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]

jobs:
  # Job 1: Lint et vérification du backend Python
  backend-lint:
    name: Backend Lint & Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./api-services
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Lint with Black
        working-directory: ./api-services
        run: |
          black --check app/ tests/
        continue-on-error: true

      - name: Lint with Flake8
        working-directory: ./api-services
        run: |
          flake8 app/ tests/ --max-line-length=88 --extend-ignore=E203,W503,E402
        continue-on-error: true

      - name: Type check with mypy
        working-directory: ./api-services
        run: |
          mypy app/ --ignore-missing-imports

  # Job 2: Tests unitaires du backend
  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./api-services
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Create test environment file
        working-directory: ./api-services
        run: |
          cat > .env.test << EOF
          DATABASE_URL=sqlite:///./test.db
          NEXT_PUBLIC_SUPABASE_URL=https://test.supabase.co
          SUPABASE_JWT_SECRET=test-jwt-secret-for-ci-testing
          EOF

      - name: Run tests with coverage
        working-directory: ./api-services
        run: |
          pytest tests/ -v --cov=app --cov-report=term-missing --cov-report=xml --cov-report=html
        env:
          PYTHONPATH: ${{ github.workspace }}/api-services

      - name: Check coverage threshold (≥80%)
        working-directory: ./api-services
        run: |
          coverage report --fail-under=80
      
      - name: Display test summary
        working-directory: ./api-services
        run: |
          echo "✅ Test Results:"
          echo "   - API Tests: tests/api/"
          echo "   - Service Tests: tests/services/"
          echo "   - CRUD Tests: tests/crud/"
          echo "   - Integration Tests: tests/integration/"
          echo "   - Fixtures Tests: tests/fixtures/"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./api-services/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
        continue-on-error: true

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ./api-services/htmlcov/
          retention-days: 7

  # Job 3: Lint et vérification du frontend Next.js
  frontend-lint:
    name: Frontend Lint & Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './client-web-app/package-lock.json'

      - name: Install dependencies
        working-directory: ./client-web-app
        run: npm ci

      - name: Create .env.local for type checking
        working-directory: ./client-web-app
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=https://placeholder.supabase.co" > .env.local
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=placeholder-key" >> .env.local

      - name: Lint with ESLint
        working-directory: ./client-web-app
        run: npm run lint

      - name: Type check
        working-directory: ./client-web-app
        run: npx tsc --noEmit

  # Job 4: Build Docker images pour vérifier qu'elles fonctionnent
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./api-services
          file: ./api-services/Dockerfile
          push: false
          tags: inventory-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./client-web-app
          file: ./client-web-app/Dockerfile
          push: false
          tags: inventory-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_SUPABASE_URL=https://placeholder.supabase.co
            NEXT_PUBLIC_SUPABASE_ANON_KEY=placeholder-anon-key-for-ci-build

  # Job 5: Tests d'intégration avec Docker Compose (optionnel au début)
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [backend-lint, backend-tests, frontend-lint, docker-build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          DB_USER=postgres
          DB_PASSWORD=postgres
          DB_NAME=inventory_db_test
          DATABASE_URL=postgresql://postgres:postgres@postgres-database:5432/inventory_db_test
          NEXT_PUBLIC_SUPABASE_URL=https://placeholder.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY=placeholder-anon-key-for-ci-test
          EOF

      - name: Start services with Docker Compose
        run: |
          docker compose up -d --build
          sleep 15

      - name: Check services are running
        run: |
          docker compose ps
          curl --fail http://localhost:8000/ || exit 1
          curl --fail http://localhost:3000/ || exit 1

      - name: Stop services
        if: always()
        run: docker compose down -v

  # Job final: Résumé du statut
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [backend-lint, backend-tests, frontend-lint, docker-build, integration-test]
    if: success()
    
    steps:
      - name: Success message
        run: |
          echo "✅ All CI checks passed successfully!"
          echo "✅ Backend tests: PASSED"
          echo "✅ Code coverage: ≥80%"
          echo "✅ Code quality: PASSED"
          echo "✅ Docker builds: PASSED"
          echo "✅ Integration tests: PASSED"
